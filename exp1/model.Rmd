---
title: "model"
author: "Rich"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This file runs some models for the morality aesthetics project

## load the libraries that we will be using ## 

## install ##

```{r install-pkg}
# install.packages("remotes")
# remotes::install_github("stan-dev/cmdstanr")
# 
# install.packages("devtools")
# devtools::install_github("jmgirard/standist")
# 
# install.packages(c("tidyverse", "RColorBrewer", "patchwork", "brms",
#                    "tidybayes", "bayesplot", "future"))
```

take a snapshot of loaded packages and update the lock.file using renv

```{r snapshot-renv}
# take a snapshot and update the lock.file
# renv::snapshot() # this is only necessary when new packages or installed or packages are updated.
```

## load ##

```{r load-pkg}
pkg <- c("cmdstanr", "standist", "tidyverse", "RColorBrewer", "patchwork", 
         "brms", "tidybayes", "bayesplot", "future", "parallel")

lapply(pkg, library, character.only = TRUE)
```

## settings ##

```{r set-options}
options(brms.backend = "cmdstanr",
        mc.cores = parallel::detectCores(),
        future.fork.enable = TRUE,
        future.rng.onMisuse = "ignore") ## automatically set in RStudio

supportsMulticore()

detectCores()
```

## plot settings ##

```{r}
## Set the amount of dodge in figures
pd <- position_dodge(0.7)
pd2 <- position_dodge(1)
```

theme settings for ggplot

```{r, eval = F}
theme_set(
  theme_bw() +
    theme(text = element_text(size = 18), 
          title = element_text(size = 18),
          legend.position = "bottom")
)
```

## read in data and create factors where necessary ##

```{r}
datad <- read_csv("exp1/data/datad.csv") %>% 
  mutate(pid = factor(pid),
         item = factor(item))
head(datad)
str(datad)
```

## load in previously saved models (as necessary) ##

This is useful if you want to look at aspects of a previously compiled model

```{r}

```

# section 1 #

## build some models ##

## b0.1 - intercepts only ##

## formula ##

```{r}
formula = bf(mvbind(use, gain, prestige, status, appreciation) ~ 1) + set_rescor(FALSE)
```

## check the priors available ##

```{r}
get_prior(formula,
          data = datad, family = cumulative("probit"))
```

## set priors ##

```{r}
# set priors #
priors <- set_prior("normal(0, 1)", class = "Intercept",
                    resp = c("use", "gain", "prestige", "status", "appreciation"))
```

## run the model ##

```{r}
plan(multicore)
b0.1 <- brm(formula = formula,
        data = datad, family = cumulative("probit"),
        prior = priors,
        iter = 5000, warmup = 1000, cores = 20, chains = 4,
        control = list(adapt_delta = 0.99, max_treedepth = 15),
        save_pars = save_pars(all=TRUE),
        seed = 123,
        init = 0.1,
        file = "exp1/models/b0.1")
summary(b0.1)
```


## bf - full model ##

## formula ##

```{r}
formula <- bf(mvbind(use, gain, prestige, status, appreciation) | thres(4, gr = item) ~ 
                1 + group * image_cat +
                (1 | p | item) +
                (1 + image_cat | a | pid)) + 
                set_rescor(FALSE)
```

## check the priors available ##

```{r}
get_prior(formula,
          data = datad, family = cumulative("probit"))
```

## set priors ##

```{r}
# set priors #
priors <- c(
  set_prior('normal(0, 1)', class = 'Intercept',
            resp = c("use", "gain", "prestige", "status", "appreciation")),
    set_prior('normal(0, 0.5)', class = 'b',
            resp = c("use", "gain", "prestige", "status", "appreciation")),
    set_prior('normal(0, 0.5)', class = 'sd',
            resp = c("use", "gain", "prestige", "status", "appreciation")),
    set_prior('lkj(2)', class = 'cor')
)
```

## run the model ##

```{r}
# this will help us track time
t1 <- Sys.time()

plan(multicore)
bf <- brm(formula = formula,
        data = datad, family = cumulative("probit"),
        prior = priors,
        iter = 5000, warmup = 1000, cores = 20, chains = 4,
        control = list(adapt_delta = 0.99, max_treedepth = 15),
        save_pars = save_pars(all=TRUE),
        seed = 123,
        init = 0.1,
        file = "exp1/models/bf")
summary(bf)

t2 <- Sys.time()

t2 - t1

# Time difference of ~ 10 hours imac.
```

take a look

pp_check 

```{r}
# (just the understanding dv for now to take a look)
pp_bf <- pp_check(bf, ndraws = 100, resp = "use")
pp_bf
```

chains

```{r}
plot(bf)
```

# section 2 #

## model diagnostics ##

```{r}
post <- as_draws_df(bf)
str(post)
```

## look at the chains for the key variables of interest ##

first take the posterior samples

```{r}
post1 <- post %>% 
  select(contains(c("b_","chain")),
         -contains(("Intercept"))) %>%  # here I select chains associated with fixed effects
  mutate(chain = .chain)
head(post1)
```

```{r}
post2 <- post %>% 
  select(contains(c("sd_", "chain"))) %>% # here I select chains associated with varying effects 
  mutate(chain = .chain)
head(post2)
```

then plot them 

```{r} 
p_chains1 <- post1 %>% 
  mcmc_trace(facet_args = list(ncol = 4)) +
  scale_x_continuous(breaks = c(0, 4000)) +
  theme(legend.position = "bottom")
p_chains1

# save it
ggsave ("exp1/figures/bf_b_chains.jpeg",
        width = 8, height = 6)
```

```{r} 
p_chains2 <- post2 %>% 
  mcmc_trace(facet_args = list(ncol = 4)) +
  scale_x_continuous(breaks = c(0, 4000)) +
  theme(legend.position = "bottom")
p_chains2

# save it
ggsave ("exp1/figures/bf_sd_chains.jpeg",
        width = 8, height = 6)
```

# other diagnostics #

```{r}
# # these two below are worth reporting.
bf_neff <- mcmc_plot(bf, type = "neff")
bf_neff
# 
bf_rhat <- mcmc_plot(bf, type = "rhat")
bf_rhat
# 
bf_diag <- bf_neff / bf_rhat
bf_diag

## save it
ggsave("exp1/figures/bf_diag.jpeg",
       width = 8, height = 6)
```