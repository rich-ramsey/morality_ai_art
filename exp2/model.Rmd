---
title: "model"
author: "Rich"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This file builds some models for Exp2 in the morality aesthetics project.

## load the libraries that we will be using ## 

## install ##

```{r install-pkg}
# install.packages("remotes")
# remotes::install_github("stan-dev/cmdstanr")
# 
# install.packages("devtools")
# devtools::install_github("jmgirard/standist")
# 
# install.packages(c("tidyverse", "RColorBrewer", "patchwork", "brms",
#                    "tidybayes", "bayesplot", "future"))
```

take a snapshot of loaded packages and update the lock.file using renv

```{r snapshot-renv}
# take a snapshot and update the lock.file
# renv::snapshot() # this is only necessary when new packages or installed or packages are updated.
```

## load ##

```{r load-pkg}
pkg <- c("cmdstanr", "standist", "tidyverse", "RColorBrewer", "patchwork", 
         "brms", "tidybayes", "bayesplot", "future", "parallel")

lapply(pkg, library, character.only = TRUE)
```

## settings ##

```{r set-options}
options(brms.backend = "cmdstanr",
        mc.cores = parallel::detectCores(),
        future.fork.enable = TRUE,
        future.rng.onMisuse = "ignore") ## automatically set in RStudio

supportsMulticore()

detectCores()
```

## plot settings ##

theme settings for ggplot

```{r, eval = F}
theme_set(
  theme_bw() +
    theme(text = element_text(size = 18), 
          title = element_text(size = 18),
          legend.position = "bottom")
)

## Set the amount of dodge in figures
pd <- position_dodge(0.7)
pd2 <- position_dodge(1)
```

## read in data and create factors where necessary ##

also select relevant variables for modelling to keep things simple 

```{r}
datadp <- read_csv("exp2/data/dprime.csv") %>%
  select(pid, groupd, targetd, attributed, dprime, ldprime) %>% 
  mutate(pid = factor(pid))
head(datadp)
str(datadp)
```

## load in previously saved models (as necessary) ##

This is useful if you want to look at aspects of a previously compiled model

```{r}

```

# section 1 #

## build some models ##

## b0.1 - intercepts only ##

just to get things going

## formula ##

```{r}
formula = bf(dprime ~ 1)
```

## check the priors available ##

```{r}
get_prior(formula,
          data = datadp, family = gaussian())
```

## visualise priors ##

here we would normally visualise priors of interest to make a judgment about what
would constitute weakly informative priors. 

https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations

a quick look at the density plots from the wrangle script shows a range from ~ -2 to +2. 
Given the density plots, maybe centre on zero.
Although impressionist AI Art looks bimodal for good. Not sure if that is meaningful or just sampling variation.
So let's plot some distributions.

```{r}
visualize("normal(0, 0.5)", "normal(0, 1)", "normal(0, 1.5)",
          xlim = c(-3, 3))
```

(0, 1) seems reasonable for the intercept

go with the same for sigma

## set priors ##

```{r}
# set priors #
priors <- c(
  set_prior("normal(0, 1)", class = "Intercept"),
  set_prior("normal(0, 1)", class = "sigma")
)
```

## run the model ##

```{r}
plan(multicore)
b0.1 <- brm(formula = formula,
        data = datadp, family = gaussian(),
        prior = priors,
        iter = 2000, warmup = 1000, cores = 8, chains = 4,
        save_pars = save_pars(all=TRUE),
        seed = 123,
        file = "exp2/models/b0.1")
summary(b0.1)
```

## take a look ##

chains

```{r}
plot(b0.1)
```

pp check

```{r}
pp_b0.1 <- pp_check(b0.1, ndraws = 100)
pp_b0.1
```


## bf - full model ##

Since d-prime is calculated based on summary data we are unable to include trial-level data.
Therefore, the only varying effect we can have by pid is a varying intercept I think.
And even including varying intercepts might not make sense because dprime is centred first. 
I'm not sure. I need to think about this.

## formula ##

```{r}
formula = bf(dprime ~ 1 + targetd * attributed * groupd +
               (1 | pid))
```

## check the priors available ##

```{r}
get_prior(formula,
          data = datadp, family = gaussian())
```

## visualise priors ##

```{r}
visualize("normal(0, 0.5)", "normal(0, 1)", "normal(0, 1.5)",
          xlim = c(-3, 3))
```

(0, 0.5) seems reasonable for b as effects will be relatively small

go with the same for sigma

## set priors ##

```{r}
# set priors #
priors <- c(
  set_prior("normal(0, 1)", class = "Intercept"),
  set_prior("normal(0, 0.5)", class = "b"),
  set_prior("normal(0, 1)", class = "sd"),
  set_prior("normal(0, 1)", class = "sigma")
)
```

## run the model ##

```{r}
plan(multicore)
bf <- brm(formula = formula,
        data = datadp, family = gaussian(),
        prior = priors,
        iter = 2000, warmup = 1000, cores = 8, chains = 4,
        save_pars = save_pars(all=TRUE),
        seed = 123,
        file = "exp2/models/bf")
summary(bf)
```

## take a look ##

chains

```{r}
plot(bf)
```

pp check

```{r}
pp_bf <- pp_check(bf, ndraws = 100)
pp_bf

pp_bfb <- pp_check(bf, ndraws = 100, type = "dens_overlay_grouped",
                   group = "targetd")
pp_bfb
```


## bf2 - full model with log(d-prime) ##

now use log(d-prime) as the dv

## formula ##

```{r}
formula = bf(ldprime ~ 1 + targetd * attributed * groupd +
               (1 | pid))
```

## check the priors available ##

```{r}
get_prior(formula,
          data = datadp, family = gaussian())
```

## visualise priors ##

for log(d-prime) the density plot ranges from -0.2 to 0.2 (approximately)

```{r}
visualize("normal(0, 0.1)", "normal(0, 0.2)", "normal(0, 0.3)",
          xlim = c(-1, 1))
```

(0, 0.2) seems reasonable for the intercept and make b relatively small

go with the same for sigma

## set priors ##

```{r}
# set priors #
priors <- c(
  set_prior("normal(0, 0.2)", class = "Intercept"),
  set_prior("normal(0, 0.1)", class = "b"),
  set_prior("normal(0, 0.2)", class = "sd"),
  set_prior("normal(0, 0.2)", class = "sigma")
)
```

## run the model ##

```{r}
plan(multicore)
bfl <- brm(formula = formula,
        data = datadp, family = gaussian(),
        prior = priors,
        iter = 2000, warmup = 1000, cores = 8, chains = 4,
        save_pars = save_pars(all=TRUE),
        seed = 123,
        file = "exp2/models/bfl")
summary(bfl)
```

## take a look ##

chains

```{r}
plot(bfl)
```

pp check

```{r}
pp_bfl <- pp_check(bfl, ndraws = 100)
pp_bfl

pp_bflb <- pp_check(bfl, ndraws = 100, type = "dens_overlay_grouped",
                   group = "targetd")
pp_bflb
```


# section 2 #

## model diagnostics ##

```{r}
post <- as_draws_df(bf)
str(post)
```

## look at the chains for the key variables of interest ##

first take the posterior samples

```{r}
post1 <- post %>% 
  select(contains(c("b_", "sd_", "chain"))) %>%  # here I select chains associated with fixed effects
  mutate(chain = .chain)
head(post1)
```

then plot them 

```{r} 
p_chains1 <- post1 %>% 
  mcmc_trace(facet_args = list(ncol = 5)) +
  scale_x_continuous(breaks = c(0, 4000)) +
  theme(legend.position = "bottom")
p_chains1

# save it
ggsave ("exp2/figures/chains.jpeg",
        width = 8, height = 6)
```

# other diagnostics #

```{r}
# # these two below are worth reporting.
bf_neff <- mcmc_plot(bf, type = "neff")
bf_neff
# 
bf_rhat <- mcmc_plot(bf, type = "rhat")
bf_rhat
# 
bf_diag <- bf_neff / bf_rhat
bf_diag

## save it
ggsave("exp2/figures/diag.jpeg",
       width = 8, height = 6)
```
